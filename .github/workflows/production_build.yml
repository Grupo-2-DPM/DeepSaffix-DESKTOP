name: DeepSaffix Nexus - Production Build (Auto-Latest)

on:
  repository_dispatch:
    types: [frontend-updated]
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: --linux
          - os: windows-latest
            target: --win

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 1. VERSIONAMIENTO DINÁMICO REFORZADO
      - name: Auto-update Version
        id: vars
        shell: bash
        run: |
          # 1. Extraer versión base
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          
          # 2. Crear versión con el run_number para que sea SIEMPRE incremental
          # Ejemplo: 1.0.19.45 (Windows prefiere puntos, Linux acepta guiones)
          NEW_VERSION="${BASE_VERSION}.${{ github.run_number }}"
          
          # 3. Debug: Escribir en el log de la Action para ver qué pasa
          echo "------------------------------------------"
          echo "DEBUG: Versión Base detectada: $BASE_VERSION"
          echo "DEBUG: Nueva Versión calculada: $NEW_VERSION"
          echo "------------------------------------------"
          
          # 4. Aplicar al package.json
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          
          # 5. Guardar como variable de entorno para el siguiente paso
          echo "FINAL_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Download Frontend Artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.ACTION_TOKEN }}
          workflow: main.yml
          run_id: ${{ github.event.client_payload.run_id }}
          name: frontend-dist
          repo: Grupo-2-DPM/DeepSaffix-WEB
          path: dist

      - name: Install Dependencies
        run: npm install

      - name: Compile TypeScript/Assets
        run: npm run compile

      # 3. CONSTRUCCIÓN Y PUBLICACIÓN FORZADA
      - name: Build and Publish Electron
        shell: bash
        run: |
          echo "Iniciando build para versión: ${{ env.FINAL_VERSION }}"
          
          # Forzamos la versión mediante el argumento -c.extraMetadata.version
          # Esto sobreescribe cualquier cosa que diga el package.json físico
          npx electron-builder ${{ matrix.target }} \
            --publish always \
            -c.extraMetadata.version=${{ env.FINAL_VERSION }} \
            -c.publish.releaseType=release \
            -c.publish.update-info-filename=latest.yml
        env:
          GH_TOKEN: ${{ secrets.ACTION_TOKEN }}